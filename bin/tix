#!/bin/bash

set -e

#PATHs
readonly NPMRC_PATH=~/.npmrc
readonly INSTALL_ROOT=$HOME
readonly CONFIG_PATH="${INSTALL_ROOT}/.tixrc"
readonly MODULE_ROOT="${INSTALL_ROOT}/tixinc"

readonly CLI_ROOT="${MODULE_ROOT}/tix-cli"
readonly CLI_PATH="${MODULE_ROOT}/tix-cli/tix-cli.js"

#URLs
readonly GITHUB_URL_BASE=https://github.com
readonly GITHUB_URL_TIX="${GITHUB_URL_BASE}/TixInc"
readonly GITHUB_URL_CLI="${GITHUB_URL_TIX}/tix-cli"

#npmrcFile=~/.npmrc
#cliFile=~/tixinc/tix-cli/tix-cli.js
#tokenFile=~/tixinc/token.json
#tixrcFile=~/.tixrc

if ! grep -q :_authToken $NPMRC_PATH; then
    echo Your npm credentials are required to interact with npm private repositories.
    echo A token will be persisted to $NPMRC_PATH...
    npm adduser
fi

$(github-token) > /dev/null

if [ ! -e $CLI_PATH ]; then
    echo Installing CLI to $CLI_ROOT...
    mkdir -p ~/tixinc/tix-cli
    git clone --depth 1 $GITHUB_URL_CLI $CLI_ROOT
    rm -rf "${CLI_ROOT}/.git"
    rm -rf "${CLI_ROOT}/.gitignore"
    rm -rf "${CLI_ROOT}/.settings"
    rm -rf "${CLI_ROOT}/img"
    rm -rf "${CLI_ROOT}/src"
fi

echo Executing CLI in $CLI_PATH...
node $CLI_PATH