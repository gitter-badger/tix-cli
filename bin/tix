#!/bin/bash
#
# This script prepares the tix-cli dependencies and starts it.

set -e
OPTIND=1

CONFIG_PATH=$HOME/.tixrc
if [ -f "$CONFIG_PATH" ] ; then
  . $CONFIG_PATH
fi

# Define flags
rewrite_tixrc=false
install_required=false
install_optional=false
clone_all=false
link_all=false
pull_all=false
non_interactive=false

usage_short="${CYAN}Usage: tix [-r] [-i] [-o] [-c] [-x] [-n]${NC}"
usage_long="$usage_short\n-r: Rewrite ~/.tixrc configuration file."
usage_long="$usage_long\n-i: Install required dependencies."
usage_long="$usage_long\n-o: Install optional dependencies."
usage_long="$usage_long\n-c: Clone all tixinc modules."
usage_long="$usage_long\n-l: Link all tixinc modules."
usage_long="$usage_long\n-p: Pull all tixinc modules."
usage_long="$usage_long\n-n: Run commands and exit."

usage_short="$usage_short\nUse -h to get supported command information."

options=":rioclpnh"

### Command line flags
while getopts "$options" opt; do
    case "$opt" in
    r ) ### Rewrites the tixrc file
      rewrite_tixrc=true
      ;;
    i ) ### Install required applications
      install_required=true
      ;;
    o ) ### Install optional files
      install_optional=true
      ;;
    c ) ### Clone all
      clone_all=true
      ;;
    l ) ### Link all
      link_all=true
      ;;
    p ) ### Pull all
      pull_all=true
      ;;
    n ) ### Skip running.
      non_interactive=true
    ;;
    h )
      >&2 echo -e "$usage_long" && exit 1
      exit 0
      ;;
    \?)
      >&2 echo -e "Unknown option: -$OPTARG"
      >&2 echo -e "$usage_short"
      exit 1
      ;;
    : )
      >&2 echo -e "Missing option argument for -$OPTARG"
      >&2 echo -e "$usage_short"
      exit 1
      ;;
    * )
      >&2 echo -e "Unimplemented option: -$OPTARG" && exit 1
      >&2 echo -e "$usage_short"
      exit 1
    esac
    shift $((OPTIND-1))
done


# Install these first
if [ "$install_required" = true ] ; then
  install-required
fi

install-tixrc
CONFIG_PATH="$HOME/.tixrc"
. "$CONFIG_PATH"

### Get tokens / auth
GITHUB_TOKEN=$(github-token)
npm-token
. "$CONFIG_PATH"

if [ ! -e "$CLI_PATH" ]; then
  install-cli
fi

if [ "$install_optional" = true ] ; then
  install-optional
fi
if [ "$rewrite_tixrc" = true ] ; then
  rm "$CONFIG_PATH"
  install-tixrc
  . "$CONFIG_PATH"
fi
if [ "$clone_all" = true ] ; then
  >&2 echo -e "--Cloning everything...--"
  clone-all-dev
  >&2 echo -e "${GREEN}--Cloning complete--${NC}"
fi
if [ "$link_all" = true ] ; then
  >&2 echo -e "--Linking everything...--"
  link-all
  >&2 echo -e "${GREEN}--Linking complete--${NC}"
fi
if [ "$pull_all" = true ] ; then
  >&2 echo -e "--Pulling everything...--"
  pull-all
  >&2 echo -e "${GREEN}--Pulling complete--${NC}"
fi
if [ "$non_interactive" = true ] ; then
  echo "-- -n norun flag specified, skipping cli execution...--"
  exit 0
fi

echo "--Executing CLI at $CLI_PATH...--"
node "${CLI_PATH}"