#!/bin/bash
#
# This script prepares the tix-cli dependencies and starts it.

set -e
OPTIND=1

### Init ~/.tixrc if it does not exist and source it
CONFIG_PATH=$HOME/.tixrc
if [ ! -e "$CONFIG_PATH" ]; then
    echo "$CONFIG_PATH doesn't exist, sourcing from GitHub..."
    random_val=$[ 1 + $[ RANDOM % 1000000 ]]
    curl -L https://raw.githubusercontent.com/TixInc/tix-cli/master/bin/tixrc?$random_val >$CONFIG_PATH
fi
. $CONFIG_PATH

### Get tokens / auth
GITHUB_TOKEN=$(github-token)
npm-token

if [ ! -e "$CLI_PATH" ]; then
  install-cli
fi

### Command line flags
while getopts "ocxnr" opt; do
    case "$opt" in
    r) ### Rewrites the tixrc file
      rm $CONFIG_PATH
      random_val=$[ 1 + $[ RANDOM % 1000000 ]]
      curl -L https://raw.githubusercontent.com/TixInc/tix-cli/master/bin/tixrc?$random_val >$CONFIG_PATH
      . $CONFIG_PATH
      ;;
    o) ### Install optional files
      install-optional
      ;;
    c) ### Clean install directories
      echo "Cleaning previous installation..."
      rimraf $CONFIG_PATH
      rimraf $NPMRC_PATH
      rimraf $CLI_ROOT
      echo "Cleaning complete."
      ;;
    x)
      pushd $CLI_ROOT
        npm install @tixinc/automation --save
      popd
      ;;
    n)
      echo "-- -n norun flag specified, skipping cli execution...--"
      exit 0
    ;;
    \?)
      exit 1
      ;;
    esac
done


echo "Executing CLI at $CLI_PATH..."
node "${CLI_PATH}"