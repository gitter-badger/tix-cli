#!/bin/bash
#
# Gets a git token from .tixrc or creates one

readonly CONFIG_PATH=$HOME/.tixrc

if [ ! -e $CONFIG_PATH ]; then
    >&2 echo Your GitHub credentials are required to interact with the GitHub api.
    >&2 echo A token will be persisted to $CONFIG_PATH...

    ### Read users GitHub credentials
    >&2 echo -n Username:
    read username
    >&2 echo -n Password:
    read -s password

    ### Call GitHub API to get a token.
    json=$(curl -s --user ${username}:${password} \
      -X POST \
      -d '{"client_id":"eae2d821f84f1bb4ae6f", "client_secret":"a097eb9f9e497f03e63af8e775aeabb489246f99", "scopes":["repo"], "note":"Repository access for tix-cli use."}' \
      https://api.github.com/authorizations) 2>&1

    ### If no token is in the response, exit
    if [[ $json != *'"token":'* ]]; then
        >&2 echo Incorrect credentials given, exiting...
        exit 1
    fi

    ### Parse out the token from the json response and stick it in the token file
    echo $json | sed 's/\,/\n/g' | tr -d '" {}' | grep ^token: | tr -d 'token:' | while read token
        do
            echo github_token=$token > $CONFIG_PATH
        done
fi

source $CONFIG_PATH

if [ -n $github_token ]; then
    echo $github_token
    exit 0
else
    >&2 echo No github token was found in the config file.
    exit 1
fi
