#!/bin/bash
#
# Deploys fresh tixinc-net artifacts

set -e
. "$HOME/.tixrc"

### if no arguments, throw an error
if [ $# -lt 1 ]; then
  >&2 echo -e "${RED}--Must specify a revision to deploy...--${NC}"
  exit 1
fi

revision="$1"

# msbuild might exist and be in path, might exist and not be in path or might not exist... thankfully MS makes this easy to install.. not
# setup default paths an test to see if its there
msbuild_path="/c/Program Files (x86)/MSBuild/12.0/Bin/MSBuild.exe"
win_msbuild_path=$(echo "$msbuild_path" | sed -e 's/^\///' -e 's/\//\\\\/g')  # strip leading slash, convert to backslash.. windows...
win_msbuild_path=$(echo "${win_msbuild_path:0:1}:${win_msbuild_path:1}")      # Add semicolon after drive
if [ ! -f "$msbuild_path" ] ; then
  # Not there, lets install
  >&2 echo -e "${BLUE}--MSBUILD not found, installing...--${NC}"
  choco install microsoft-build-tools

  # These downloads might help at some point
  #http://download.microsoft.com/download/9/B/B/9BB1309E-1A8F-4A47-A6C5-ECF76672A3B3/BuildTools_Full.exe
  #choco install netfx-4.5.2-devpack
fi
if [ ! -f "$msbuild_path" ] ; then
  >&2 echo -e "${RED}--MSBUILD still not found... hail mary to see if it is in default path--${NC}"
  msbuild_path="msbuild"
  win_msbuild_path="msbuild"
fi


echo "--executing build-net $revision--"
build-net "$revision"

>&2 echo "--Building and deploying artifacts revision $revision--"
pushd "$NET_BUILD_ROOT" >/dev/null
  >&2 echo "--Restoring packages--"
  nuget restore Tix.SelfHost.sln -PackagesDirectory packages -Verbosity quiet -NonInteractive
  >&2 echo "--Packages restored successfully--"

  >&2 echo "--Cleaning $NET_ARTIFACTS_ROOT--"
  rimraf "$NET_ARTIFACTS_ROOT"
  mkdirp "$NET_ARTIFACTS_ROOT"
  >&2 echo "--MSBUILD artifacts--"
  win_artifacts_root=$(echo "$NET_ARTIFACTS_ROOT" | sed -e 's/^\///'  -e 's/\//\\\\/g')  # strip leading slash and convert to backslash
  win_artifacts_root=$(echo "${win_artifacts_root:0:1}:${win_artifacts_root:1}")        # Add semicolon after drive
  >&2 echo "Building to $win_artifacts_root"

  >&2 echo "Executing... -> cmd //c \"$win_msbuild_path\" Tix.Web.SelfHost\\Tix.Web.SelfHost.csproj //nologo //p:Configuration=Debug //p:OutputPath=\"${win_artifacts_root}\" //m //v:m //clp:ErrorsOnly"
  cmd //c "$win_msbuild_path" Tix.Web.SelfHost\\Tix.Web.SelfHost.csproj //nologo //p:Configuration=Debug //p:OutputPath="${win_artifacts_root}" //m //v:m //clp:ErrorsOnly
  >&2 echo "--MSBUILD finished successfully--"

  >&2 echo "--Cleaning packages--"
  rimraf packages
  >&2 echo "--Packages cleaned successfully--"
popd >/dev/null

if ! hash cryptkeeper 2>/dev/null; then
  npm install -g cryptkeeper &>/dev/null
fi

config_path="$NET_ARTIFACTS_ROOT/Tix.Web.SelfHost.exe.config"
cryptkeeper -e -n -s "connectionStrings" "$config_path"

>&2 echo -e "${GREEN}--Artifacts revision $revision successfully deployed--${NC}"