#!/bin/bash
#
# Deploys fresh tixinc-net artifacts

set -e

### if no arguments, throw an error
if [ $# -lt 1 ]; then
  >&2 echo -e "${RED}Must specify a revision to deploy...${NC}"
  exit 1
fi

. $HOME/.tixrc

revision=$1

>&2 echo "--Cleaning artifacts--"
rimraf "$NET_ARTIFACTS_ROOT"

build-net $revision

>&2 echo "--Building and deploying artifacts revision $revision--"
pushd $NET_BUILD_ROOT >/dev/null
  echo "--Restoring packages--"
  nuget restore Tix.SelfHost.sln -PackagesDirectory packages -Verbosity quiet -NonInteractive
  echo "--Packages restored successfully--"

  mkdirp "$NET_ARTIFACTS_ROOT"
  echo "--MSBUILD artifacts--"
  win_artifacts_path=$(echo "$NET_ARTIFACTS_PATH" | sed -e 's/^\///'  -e 's/\//\\\\/g')  # strip leading slash and convert to backslash
  win_artifacts_path=$(echo "${win_artifacts_path:0:1}:${win_artifacts_path:1}")        # Add semicolon after drive

  cmd //c msbuild Tix.Web.SelfHost\\Tix.Web.SelfHost.csproj //nologo //p:Configuration=Debug //p:OutputPath=${win_artifacts_path} //m //v:m //clp:ErrorsOnly
  echo "--MSBUILD finished successfully--"

  echo "--Cleaning packages--"
  rimraf packages
  echo "--Packages cleaned successfully--"
popd >/dev/null

>&2 echo -e "${GREEN}--Artifacts revision $revision successfully deployed--${NC}"