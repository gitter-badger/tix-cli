#!/bin/bash
#
# Deploys fresh tixinc-js artifacts

set -e
. "$HOME/.tixrc"

### if no arguments, throw an error
if [ $# -lt 1 ]; then
  >&2 echo -e "${RED}--Must specify a revision to deploy...--${NC}"
  exit 1
fi

revision="$1"

echo "--executing build-js $revision--"
build-js "$revision"

>&2 echo "--Cleaning and copying artifacts revision $revision--"
pushd "$JS_BUILD_ROOT" >/dev/null
  >&2 echo "--Cleaning $JS_ARTIFACTS_ROOT--"
  rimraf "$JS_ARTIFACTS_ROOT"
  mkdirp "$JS_ARTIFACTS_ROOT"
  cp -rf ./ "$JS_ARTIFACTS_ROOT"
popd >/dev/null

>&2 echo "--Building artifacts revision $revision--"
pushd "$JS_ARTIFACTS_ROOT" >/dev/null
  npm install --production
  >&2 echo "--downloading 64 bit node.exe to bin--"
  curl -sL http://nodejs.org/dist/latest/x64/node.exe >bin/node.exe

  >&2 echo "--cleaning unecessary production files--"
  rimraf .git
  rimraf .gitignore
  rimraf gulpfile.js
  rimraf build
  rimraf test
  rimraf wwwroot/app
  rimraf wwwroot/core
  rimraf wwwroot/globals
  rimraf wwwroot/assets/less
  rimraf wwwroot/assets/maps
  rimraf wwwroot/assets/styl
  rimraf wwwroot/assets/stylus
  rimraf wwwroot/assets/swatch
popd >/dev/null

>&2 echo -e "${GREEN}--Artifacts revision $revision successfully deployed--${NC}"
